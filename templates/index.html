{% extends 'base.html' %}
{% block content %}
<body class="bg-gray-100">
    <header class="text-center py-10">
        <h2 class="text-3xl font-bold text-gray-800">Welcome to ArtSonix!</h2>
    </header>

    <!-- Mood Selection Modal -->
    <div id="mood-modal" class="hidden fixed inset-0 overflow-y-auto" style="z-index: 9999;">
        <!-- Background backdrop -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
        
        <!-- Modal container for centering -->
        <div class="relative flex min-h-screen items-center justify-center">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow-xl mx-4 w-full max-w-lg">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900">Too Many Moods Selected</h3>
                    <p class="mt-2 text-sm text-gray-500">You can only select up to 3 moods. Please deselect one before selecting another.</p>
                    <div class="mt-4 flex justify-end">
                        <button type="button" id="close-mood-modal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-500 font-medium">
                            Okay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Art Style Selection Modal -->
    <div id="art-style-modal" class="hidden fixed inset-0 overflow-y-auto" style="z-index: 9999;">
        <!-- Background backdrop -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
        
        <!-- Modal container for centering -->
        <div class="relative flex min-h-screen items-center justify-center">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow-xl mx-4 w-full max-w-lg">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900">Too Many Art Styles Selected</h3>
                    <p class="mt-2 text-sm text-gray-500">You can only select up to 3 art styles. Please deselect one before selecting another.</p>
                    <div class="mt-4 flex justify-end">
                        <button type="button" id="close-art-style-modal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-500 font-medium">
                            Okay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="flex items-center justify-center">
        <div class="max-w-2xl mx-auto p-6 bg-white shadow-lg rounded-2xl">
            <h1 class="text-2xl font-bold text-gray-800">Discover Music Through Art</h1>
            <form id="preference-form" class="mt-4">
                <!-- Q1: Mood Selection -->
                <div class="form-section mb-6">
                    <label class="block mb-2 text-lg font-medium text-gray-800">What is your mood today? (Pick up to 3)</label>
                    <div class="checkbox-group" id="mood-group">
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Inspired"> Inspired
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Creative"> Creative
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Calm"> Calm
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Energetic"> Energetic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Adventurous"> Adventurous
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Happy"> Happy
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Sad"> Sad
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Romantic"> Romantic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Focused"> Focused
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Upbeat"> Upbeat
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Rebellious"> Rebellious
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Dark"> Dark
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Nostalgic"> Nostalgic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Trippy"> Trippy
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Party"> Party
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Epic"> Epic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Quirky"> Quirky
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Emotional"> Emotional
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="open"> I'm open to anything
                        </label>
                    </div>
                    <div class="max-selections-warning text-red-500 text-sm mt-2" id="mood-warning">
                        Maximum 3 selections allowed
                    </div>
                </div>

                <!-- Q2: Art Style Selection -->
                <div class="form-section mb-6">
                    <label class="block mb-2 text-lg font-medium text-gray-800">What is your favorite art style? (Pick up to 3)</label>
                    <div class="checkbox-group" id="art-style-group">
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Cubism"> Cubism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Abstract"> Abstract
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Contemporary art"> Contemporary art
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Modern"> Modern
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Impressionism"> Impressionism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Baroque"> Baroque
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Romanticism"> Romanticism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Pre-Raphaelite"> Pre-Raphaelite
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Op Art"> Op Art
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Futurism"> Futurism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Tonalism"> Tonalism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Open"> I'm open to anything
                        </label>
                    </div>
                    <div class="max-selections-warning text-red-500 text-sm mt-2" id="art-style-warning">
                        Maximum 3 selections allowed
                    </div>
                </div>

                <!-- Q3: Subject Selection -->
                <label for="subject" class="block mb-2 text-lg font-medium text-gray-800 mt-4">What subjects capture your interest?</label>
                <select id="subject" name="subject" class="bg-gray-50 border border-gray-300 text-gray-800 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="">Choose a subject</option>
                    <option value="Human Stories">Human Stories (portraits, daily life)</option>
                    <option value="Nature & Landscapes">Nature & Landscapes</option>
                    <option value="Religious & Mythological">Religious & Mythological</option>
                    <option value="Historical Events">Historical Events</option>
                    <option value="Abstract & Decorative">Abstract & Decorative</option>
                    <option value="Open">I'm open to anything</option>
                </select>

                <!-- Buttons -->
                <div class="mt-6 flex space-x-4">
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 cursor-pointer">
                        Get Recommendations
                    </button>
                    <button type="button" id="surpriseBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 cursor-pointer" style="width: auto;">
                        Surprise Me!
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function setupCheckboxGroup(groupName, maxSelections) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
            const modalId = groupName === 'moods' ? 'mood-modal' : 'art-style-modal';
            const modal = document.getElementById(modalId);
            const closeButton = document.getElementById(`close-${modalId}`);
            const backdrop = modal.querySelector('.bg-black');
            
            function showModal() {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function hideModal() {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedBoxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
                    
                    if (checkedBoxes.length > maxSelections) {
                        checkbox.checked = false;
                        showModal();
                    }
                });
            });
        
            // Close modal when "Okay" button is clicked
            closeButton.addEventListener('click', hideModal);
        
            // Close modal when clicking backdrop
            modal.addEventListener('click', (event) => {
                if (event.target === modal || event.target === backdrop) {
                    hideModal();
                }
            });
        
            // Close modal on escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
                    hideModal();
                }
            });
        }
    
        // Form submission handler
        document.getElementById("preference-form").addEventListener("submit", function(event) {
            event.preventDefault();
            
            // Show loading overlay ONLY when button is clicked
            const loadingOverlay = document.getElementById("loading-overlay");
            loadingOverlay.classList.remove("hidden");
            
            const selectedMoods = Array.from(document.querySelectorAll('input[name="moods"]:checked'))
                .map(checkbox => checkbox.value);
    
            const selectedArtStyles = Array.from(document.querySelectorAll('input[name="art_styles"]:checked'))
                .map(checkbox => checkbox.value);
    
            const subject = document.getElementById("subject").value;
    
            fetch('/process-preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    moods: selectedMoods, 
                    art_styles: selectedArtStyles, 
                    subject: subject 
                })
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (!data.error) {
                    localStorage.setItem('artworks', JSON.stringify(data));
                    window.location.href = '/results';
                } else {
                    loadingOverlay.classList.add("hidden");
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                loadingOverlay.classList.add("hidden");
                console.error('Fetch Error:', error);
                alert('Failed to get recommendations. Please try again.');
            });
        });
    
        // Surprise button handler
        document.getElementById("surpriseBtn").addEventListener("click", function() {
            const loadingOverlay = document.getElementById("loading-overlay");
            loadingOverlay.classList.remove("hidden");
    
            fetch('/surprise-me')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data.error) {
                        localStorage.setItem('artworks', JSON.stringify(data));
                        window.location.href = '/results';
                    } else {
                        loadingOverlay.classList.add("hidden");
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    loadingOverlay.classList.add("hidden");
                    console.error('Error:', error);
                    alert('Failed to load surprise recommendations. Please try again.');
                });
        });
    
        // Initialize checkbox groups
        document.addEventListener('DOMContentLoaded', () => {
            setupCheckboxGroup('moods', 3);
            setupCheckboxGroup('art_styles', 3);
            
            // Ensure overlay is hidden on initial load
            document.getElementById("loading-overlay").classList.add("hidden");
        });
    
        // Handle browser navigation
        window.addEventListener('pageshow', function(event) {
            document.getElementById("loading-overlay").classList.add("hidden");
        });
    </script>

    </body>
{% endblock %}
