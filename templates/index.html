{% extends 'base.html' %}
{% block content %}
<body class="bg-gray-100">
    <header class="text-center py-10">
        <h2 class="text-3xl font-bold text-gray-800">Welcome to ArtSonix!</h2>
    </header>
    <div class="flex items-center justify-center">
        <div class="max-w-2xl mx-auto p-6 bg-white shadow-lg rounded-2xl">
            <h1 class="text-2xl font-bold text-gray-800">Discover Music Through Art</h1>
            <form id="preference-form" class="mt-4">
                <!-- Q1: Mood Selection -->
                <div class="form-section mb-6">
                    <label class="block mb-2 text-lg font-medium text-gray-800">What is your mood today? (Pick up to 3)</label>
                    <div class="checkbox-group" id="mood-group">
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Inspired"> Inspired
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Creative"> Creative
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Calm"> Calm
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Energetic"> Energetic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Adventurous"> Adventurous
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Happy"> Happy
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Sad"> Sad
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Romantic"> Romantic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Focused"> Focused
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Upbeat"> Upbeat
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Rebellious"> Rebellious
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Dark"> Dark
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Nostalgic"> Nostalgic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Trippy"> Trippy
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Party"> Party
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Epic"> Epic
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Quirky"> Quirky
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="Emotional"> Emotional
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="moods" value="open"> I'm open to anything
                        </label>
                    </div>
                    <div class="max-selections-warning text-red-500 text-sm mt-2" id="mood-warning">
                        Maximum 3 selections allowed
                    </div>
                </div>

                <!-- Q2: Art Style Selection -->
                <div class="form-section mb-6">
                    <label class="block mb-2 text-lg font-medium text-gray-800">What is your favorite art style? (Pick up to 3)</label>
                    <div class="checkbox-group" id="art-style-group">
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Cubism"> Cubism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Abstract"> Abstract
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Contemporary art"> Contemporary art
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Modern"> Modern
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Impressionism"> Impressionism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Baroque"> Baroque
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Romanticism"> Romanticism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Pre-Raphaelite"> Pre-Raphaelite
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Op Art"> Op Art
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Futurism"> Futurism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Tonalism"> Tonalism
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" name="art_styles" value="Open"> I'm open to anything
                        </label>
                    </div>
                    <div class="max-selections-warning text-red-500 text-sm mt-2" id="art-style-warning">
                        Maximum 3 selections allowed
                    </div>
                </div>

                <!-- Q3: Art Period Selection -->
                <label for="period" class="block mb-2 text-lg font-medium text-gray-800">Do you have a favorite art period?</label>
                <select id="period" name="period" class="bg-gray-50 border border-gray-300 text-gray-800 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="">Choose an art period</option>
                    <option value="Ancient">Ancient (Before 500 CE)</option>
                    <option value="Medieval & Renaissance">Medieval & Renaissance (500-1500 CE)</option>
                    <option value="Early Modern">Early Modern (1500-1800 CE)</option>
                    <option value="Modern">Modern (1800-1945 CE)</option>
                    <option value="Contemporary">Contemporary (1945-present CE)</option>
                    <option value="Open">I'm open to anything</option>
                </select>

                <!-- Q4: Subject Selection -->
                <label for="subject" class="block mb-2 text-lg font-medium text-gray-800 mt-4">What subjects capture your interest?</label>
                <select id="subject" name="subject" class="bg-gray-50 border border-gray-300 text-gray-800 text-base rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <option value="">Choose a subject</option>
                    <option value="Human Stories">Human Stories (portraits, daily life)</option>
                    <option value="Nature & Landscapes">Nature & Landscapes</option>
                    <option value="Religious & Mythological">Religious & Mythological</option>
                    <option value="Historical Events">Historical Events</option>
                    <option value="Abstract & Decorative">Abstract & Decorative</option>
                    <option value="Open">I'm open to anything</option>
                </select>

                <!-- Buttons -->
                <div class="mt-6 flex space-x-4">
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 cursor-pointer">
                        Get Recommendations
                    </button>
                    <button type="button" id="surpriseBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 cursor-pointer" style="width: auto;">
                        Surprise Me!
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function setupCheckboxGroup(groupName, maxSelections) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
            const warningElement = document.getElementById(`${groupName.replace('_', '-')}-warning`);
    
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedBoxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
                    
                    if (checkedBoxes.length > maxSelections) {
                        checkbox.checked = false;
                        warningElement.style.display = 'block';
                        setTimeout(() => {
                            warningElement.style.display = 'none';
                        }, 2000);
                    }
                });
            });
        }
    
        // Form submission handler
        document.getElementById("preference-form").addEventListener("submit", function(event) {
            event.preventDefault();
            
            // Show loading overlay ONLY when button is clicked
            const loadingOverlay = document.getElementById("loading-overlay");
            loadingOverlay.classList.remove("hidden");
            
            const selectedMoods = Array.from(document.querySelectorAll('input[name="moods"]:checked'))
                .map(checkbox => checkbox.value);
    
            const selectedArtStyles = Array.from(document.querySelectorAll('input[name="art_styles"]:checked'))
                .map(checkbox => checkbox.value);
    
            const period = document.getElementById("period").value;
            const subject = document.getElementById("subject").value;
    
            fetch('/process-preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    moods: selectedMoods, 
                    art_styles: selectedArtStyles, 
                    period: period, 
                    subject: subject 
                })
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (!data.error) {
                    localStorage.setItem('artworks', JSON.stringify(data));
                    window.location.href = '/results';
                } else {
                    loadingOverlay.classList.add("hidden");
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                loadingOverlay.classList.add("hidden");
                console.error('Fetch Error:', error);
                alert('Failed to get recommendations. Please try again.');
            });
        });
    
        // Surprise button handler
        document.getElementById("surpriseBtn").addEventListener("click", function() {
            const loadingOverlay = document.getElementById("loading-overlay");
            loadingOverlay.classList.remove("hidden");
    
            fetch('/surprise-me')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data.error) {
                        localStorage.setItem('artworks', JSON.stringify(data));
                        window.location.href = '/results';
                    } else {
                        loadingOverlay.classList.add("hidden");
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    loadingOverlay.classList.add("hidden");
                    console.error('Error:', error);
                    alert('Failed to load surprise recommendations. Please try again.');
                });
        });
    
        // Initialize checkbox groups
        document.addEventListener('DOMContentLoaded', () => {
            setupCheckboxGroup('moods', 3);
            setupCheckboxGroup('art_styles', 3);
            
            // Ensure overlay is hidden on initial load
            document.getElementById("loading-overlay").classList.add("hidden");
        });
    
        // Handle browser navigation
        window.addEventListener('pageshow', function(event) {
            document.getElementById("loading-overlay").classList.add("hidden");
        });
    </script>

    </body>
    {% endblock %}
