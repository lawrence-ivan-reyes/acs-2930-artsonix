{% extends 'base.html' %}
{% block content %}
<header class="header-section">
    <h2 class="text-3xl font-bold">Welcome to ArtSonix! Discover Music Through Art</h2>
    <p class="text-lg mt-3">Experience the perfect blend of visual and auditory art tailored to your preferences</p>
</header>

<div class="flex items-center justify-center py-6">
    <div class="max-w-4xl w-full mx-auto">
        <div class="form-container">
            <form id="combined-form" class="mt-4" action="/combined-results" method="post">
                <fieldset class="border border-gray-300 p-4 rounded-lg mb-6">
                    <legend class="form-legend px-2">Find Your Music and Art Match</legend>

                    <!-- Mood Selection -->
                    <div class="mb-6">
                        <p class="form-label">Select up to 3 moods:</p>
                        <div class="checkbox-container">
                            {% for mood in ["Inspired", "Creative", "Calm", "Energetic", "Adventurous", "Happy", "Sad", "Romantic", "Focused", "Upbeat", "Rebellious", "Dark", "Nostalgic", "Trippy", "Party", "Epic", "Quirky", "Emotional"] %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="moods" value="{{ mood }}" class="mood-checkbox mr-2">
                                    <span>{{ mood }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Media Type Selection -->
                    <div class="mb-6">
                        <p class="form-label">Choose what you want to search for:</p>
                        <div class="radio-container">
                            {% for media in ["Playlist", "Album", "Artist", "Track", "I'm open to anything"] %}
                                <label class="radio-label">
                                    <input type="radio" name="rec_type" value="{{ media.lower() }}" class="mr-2" {% if loop.first %}checked{% endif %}>
                                    <span>{{ media }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Search Query -->
                    <div class="mb-6">
                        <p class="form-label">Or enter a specific search query:</p>
                        <input type="text" id="search-query" name="query" class="form-control" placeholder="Enter artist, album, playlist, or song (optional)">
                    </div>

                    <!-- Art Style Selection -->
                    <div class="mb-6">
                        <p class="form-label">Select your favorite art styles (up to 3):</p>
                        <div class="checkbox-container">
                            {% for art_style in ["Cubism", "Abstract", "Contemporary art", "Modern", "Impressionism", "Baroque", "Romanticism", "Pre-Raphaelite", "Op Art", "Futurism", "Tonalism", "I'm open to anything"] %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="art_styles" value="{{ art_style }}" class="art-style-checkbox mr-2">
                                    <span>{{ art_style }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Subject Selection -->
                    <div class="mb-4">
                        <label for="subject" class="form-label">Choose a subject that captures your interest:</label>
                        <select id="subject" name="subject" class="form-control">
                            <option value="">Choose a subject</option>
                            <option value="Human Stories">Human Stories (portraits, daily life)</option>
                            <option value="Nature & Landscapes">Nature & Landscapes</option>
                            <option value="Religious & Mythological">Religious & Mythological</option>
                            <option value="Historical Events">Historical Events</option>
                            <option value="Abstract & Decorative">Abstract & Decorative</option>
                            <option value="Open">I'm open to anything</option>
                        </select>
                    </div>
                </fieldset>

                <!-- Submit Buttons -->
                <button type="submit" class="btn-primary">Find Music & Art</button>
                <button type="button" id="surpriseBtn" class="btn-surprise">Surprise Me!</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Too Many Selections -->
<div id="mood-modal" class="modal hidden">
    <div class="modal-content">
        <h3 class="modal-title">Too Many Selections</h3>
        <p class="text-gray-600 mb-4">You can only select up to 3 items. Please deselect one before adding another.</p>
        <button id="close-modal" class="modal-btn">Okay</button>
    </div>
</div>

<!-- Loading Screen -->
<div id="loading-screen" class="loading-screen hidden">
    <div class="loading-container">
        <span class="text-xl font-bold">Loading<span id="loading-dots" class="loading-dots"></span></span>
    </div>
</div>

<script>
    // Limit selections to 3
    const limitSelections = (className) => {
        document.querySelectorAll(className).forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                let checkedBoxes = document.querySelectorAll(`${className}:checked`);
                if (checkedBoxes.length > 3) {
                    this.checked = false;
                    document.getElementById('mood-modal').classList.remove('hidden');
                }
            });
        });
    };

    // Close modal
    document.getElementById('close-modal').addEventListener('click', function () {
        document.getElementById('mood-modal').classList.add('hidden');
    });

    // Form submit handler
    document.getElementById('combined-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading screen
        document.getElementById('loading-screen').classList.remove('hidden');
        
        try {
            // Get form data
            const formData = new FormData(this);
            
            // Send POST request
            const response = await fetch('/combined-results', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            // Get the results and update the page
            const results = await response.json();
            
            // Store both Met and Spotify results in localStorage
            localStorage.setItem('artworks', JSON.stringify(results.met_results));
            localStorage.setItem('spotify_results', JSON.stringify(results.spotify_results));
            
            // Redirect to results page
            window.location.href = '/results';

        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        } finally {
            document.getElementById('loading-screen').classList.add('hidden');
        }
    });

    // Surprise button handler
    document.getElementById('surpriseBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        
        // Show loading screen
        document.getElementById('loading-screen').classList.remove('hidden');
        
        try {
            // Make request to the surprise-me endpoint
            const response = await fetch('/surprise-me');
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            // Parse the response
            const combinedResults = await response.json();
            
            // Store both Met and Spotify results in localStorage
            localStorage.setItem('artworks', JSON.stringify(combinedResults.met_results || []));
            localStorage.setItem('spotify_results', JSON.stringify(combinedResults.spotify_results || []));
            
            // Redirect to results page
            window.location.href = '/results';
            
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while generating surprise recommendations.');
        } finally {
            document.getElementById('loading-screen').classList.add('hidden');
        }
    });

    // Initialize checkbox limitation
    limitSelections('.mood-checkbox');
    limitSelections('.art-style-checkbox');

    // Loading dots animation
    const dotsElement = document.getElementById('loading-dots');
    let dots = 1;
    setInterval(() => {
        dotsElement.textContent = '.'.repeat(dots);
        dots = dots < 3 ? dots + 1 : 1;
    }, 500);
</script>
{% endblock %}
